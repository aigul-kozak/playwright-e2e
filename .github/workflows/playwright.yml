name: Playwright E2E (Nightly)

on:
  # Nightly run + manual run possibility
  schedule:
    - cron: "0 2 * * *" # every day at 02:00 UTC
  workflow_dispatch: # manual run

jobs:
  nightly:
    name: Nightly Playwright E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Nightly Playwright projects
        run: |
          npx playwright test \
            --project=mobileMid-portrait-chromium-ar \
            --project=mobileMin-portrait-chromium-ku \
            --project=tabletSmall-portrait-webkit-ar \
            --project=tabletSmall-landscape-webkit-ar \
            --project=desktop-chromium-en \
            --project=desktop-firefox-ar \
            --project=desktop-webkit-ku \
            --reporter=html
        continue-on-error: true # to allow report publishing and Slack notification even if tests fail

      - name: Publish Playwright report (unique run)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAGES_PAT }}
          publish_dir: ./playwright-report
          publish_branch: gh-pages
          destination_dir: ${{ github.run_number }}-${{ github.run_id }}

      - name: Publish Playwright report (latest)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAGES_PAT }}
          publish_dir: ./playwright-report
          publish_branch: gh-pages
          destination_dir: latest

      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author
          text: |
            ðŸŒ™ *Nightly Playwright E2E Run completed*

            *Status:* ${{ job.status }}

            *Projects ran:*
            â€¢ mobileMid-portrait-chromium-ar
            â€¢ mobileMid-landscape-chromium-ku
            â€¢ tabletSmall-portrait-webkit-ar
            â€¢ tabletSmall-landscape-webkit-ar
            â€¢ desktop-chromium-en
            â€¢ desktop-firefox-ar
            â€¢ desktop-webkit-ku

            ðŸ“Š *HTML report:* https://aigul-kozak.github.io/playwright-e2e/latest/
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
